<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AQUARIS AI-Otolith Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Inter:wght@400;600;700;800&display=swap');
        
        /* 1. Base Styling - Matching index.html */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d0d; /* Very dark, almost black */
            color: white;
            /* Added space for the fixed header */
            padding-top: 5rem; 
        }
        
        /* 2. Card and Panel Styling - Dark Background */
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Stronger shadow on dark mode */
            border: 1px solid #1f2937; /* Dark gray border */
            background-color: #1f2937; /* bg-gray-800 for cards */
            border-radius: 1rem;
        }
        
        /* Removed header-bg styling */
        
        /* 4. Suitability Bar Styles */
        .score-bar-container {
            height: 1.75rem;
            background-color: #0f172a; /* Dark slate background */
            border-radius: 0.8rem;
            overflow: hidden;
            position: relative;
        }
        .score-bar {
            transition: width 0.7s ease-in-out;
        }
        #suitabilityFishIndicator {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%) scaleX(1);
            transition: left 0.7s ease-in-out, transform 0.7s ease-in-out;
            pointer-events: none;
            z-index: 10;
        }
        
        /* 5. Map Styling (Deep Ocean Look) */
        #oceanMapCanvas {
            background: linear-gradient(180deg, #111827 0%, #064e3b 100%); /* Deep dark blue to dark teal gradient */
            border: 4px solid #06b6d4; /* Cyan border */
        }

        /* Map Axis Labels - High Contrast */
        .map-axis-label {
            color: #22d3ee; /* Cyan for labels */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        /* 6. Button and Select Focus - Cyan Focus Ring */
        .focus-ring-cyan:focus {
            border-color: #06b6d4; /* cyan-500 */
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.4); /* cyan-500 with transparency */
        }
        
        /* Text Color adjustments for dark mode readability */
        .text-cyan-700 { color: #0e7490; } /* Darker cyan for contrast on light cyan elements */
    </style>
</head>
<body class="min-h-screen">
    
    <header class="fixed top-0 left-0 w-full bg-[#0d0d0d] bg-opacity-90 backdrop-blur-sm z-50 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-start items-center">
            <a href="index.html" title="Back to Main Page"
               class="p-2 rounded-full hover:bg-gray-700 transition">
                <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
        </div>
    </header>
    
    <div class="max-w-7xl mx-auto p-4 sm:p-8">
        <div class="text-center mt-6 mb-10 pt-4"> 
            <h1 id="mainTitle" class="text-4xl sm:text-5xl font-extrabold tracking-tight text-cyan-400">AQUARIS AI-Otolith Analysis</h1>
            
        </div>

        <main>
            <div class="card p-6 mb-8 border border-gray-700">
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="fishSelect" class="block text-sm font-semibold text-gray-300 mb-2">1. Select Species:</label>
                        <select id="fishSelect" class="w-full p-3 border border-cyan-400 bg-gray-900 text-white rounded-lg focus-ring-cyan transition duration-150 text-base" onchange="initializeFishData()">
                            <option value="" disabled selected>-- Select Species --</option>
                            <option value="Puffer">Green Spotted Puffer</option>
                            <option value="Bangus">Bangus (Milkfish)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="analysisTypeSelect" class="block text-sm font-semibold text-gray-300 mb-2">2. Select Analysis Type:</label>
                        <select id="analysisTypeSelect" class="w-full p-3 border border-cyan-400 bg-gray-900 text-white rounded-lg focus-ring-cyan transition duration-150 text-base" onchange="toggleAnalysisMode()">
                            <option value="Migration Simulation" selected>Migration Simulation</option>
                            <option value="Ocean Grid Analysis">Ocean Grid Analysis</option>
                        </select>
                    </div>

                    <div id="lifeStageControl">
                        <label for="lifeStageSelect" class="block text-sm font-semibold text-gray-300 mb-2">3. Select Life Stage:</label>
                        <select id="lifeStageSelect" class="w-full p-3 border border-cyan-400 bg-gray-900 text-white rounded-lg focus-ring-cyan transition duration-150 text-base" onchange="checkInputs()">
                            <option value="" disabled selected>-- Choose Stage --</option>
                            </select>
                    </div>
                </div>

                <div id="aiInsightCard" class="bg-gray-900 p-4 rounded-lg border-l-4 border-cyan-500 shadow-inner">
                    <h2 class="text-lg font-bold text-cyan-400 mb-2">AI Insight</h2>
                    <p class="text-sm text-gray-400">Select a species above to view its habitat requirements and migration insights.</p>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div class="card p-6 border-gray-700">
                        <h2 class="text-xl font-extrabold mb-4 text-cyan-400 border-b border-gray-700 pb-2">Location Input</h2>
                        <div class="mb-6">
                            <label for="gridSelect" class="block text-sm font-medium text-gray-300 mb-1">Select Potential Habitat (Grid):</label>
                            <select id="gridSelect" class="w-full p-3 rounded-lg border border-gray-700 bg-gray-900 text-white focus-ring-cyan transition duration-150" onchange="checkInputs()">
                                <option value="" disabled selected>Choose a Grid Location</option>
                                </select>
                        </div>
                        <button onclick="runAnalysis()" id="analyzeButton" class="w-full bg-cyan-500 text-gray-900 py-3 rounded-xl font-bold text-lg shadow-md hover:bg-cyan-600 transition duration-300 disabled:opacity-50 disabled:shadow-none" disabled>
                            Run Analysis & Migration Check üê†
                        </button>
                    </div>

                    <div class="card p-4 border-gray-700">
                        <h2 class="text-xl font-extrabold mb-2 text-cyan-400 border-b border-gray-700 pb-2">9x7 Ocean Grid Visualization</h2>
                        <div class="flex justify-center">
                            <div id="oceanMapContainer" class="w-full relative">
                                <div id="colLabels" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
                                <div id="rowLabels" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
                                <canvas id="oceanMapCanvas"></canvas>
                                <span id="mapFishIndicator" class="transition-all duration-700 text-3xl z-20" style="display: none;">üêü</span>
                                
                                <div id="mapLegend" class="absolute -bottom-6 left-1/2 -translate-x-1/2 flex flex-wrap justify-center space-x-3 text-xs font-bold bg-gray-900/80 backdrop-blur-sm px-4 py-2 rounded-xl shadow-lg border border-cyan-500">
                                    <span class="text-cyan-400">‚óè Origin (E4)</span>
                                    <span class="text-orange-500">‚óè Selected Grid</span>
                                    <span class="text-green-500">‚óè Migration Target</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 card p-6 border-gray-700 h-fit">
                    <h2 class="text-2xl font-extrabold mb-4 text-cyan-400 border-b border-gray-700 pb-2">Analysis Results & Suitability</h2>

                    <div id="initialMessage" class="text-center text-xl text-gray-400 p-10 bg-gray-900 rounded-lg shadow-inner border border-gray-700">
                        <p>Select a **Species**, **Life Stage**, and **Grid Location** to begin the analysis.</p>
                    </div>

                    <div id="resultsDisplay" class="hidden space-y-6">
                        <div class="p-5 bg-gray-900 rounded-xl border border-cyan-500">
                            <h3 class="text-xl font-bold text-cyan-400 mb-2">Overall Habitat Suitability Score</h3>
                            <div class="flex justify-between items-center mb-3">
                                <p class="text-lg font-medium text-gray-300">Score for Selected Grid (100% is perfect):</p>
                                <span id="scoreText" class="text-3xl font-extrabold text-cyan-500">--</span>
                            </div>
                            <div class="score-bar-container">
                                <div id="scoreBar" class="score-bar h-full" style="width: 0%"></div>
                                <span id="suitabilityFishIndicator" class="text-2xl">üêü</span>
                            </div>
                            <p id="suitabilityVerdict" class="mt-3 text-sm italic font-medium text-gray-400"></p>
                        </div>

                        <div id="migrationStatus" class="p-5 rounded-xl border-4">
                            <h3 class="text-xl font-bold mb-3 text-gray-300">Migration Prediction Summary üß≠</h3>
                            <p id="migrationMessage" class="text-base font-semibold">--</p>
                        </div>

                        <h3 class="text-xl font-bold text-cyan-400 mb-3 border-b border-gray-700 pb-1">Environmental Factor Breakdown</h3>
                        <div class="overflow-x-auto shadow-lg rounded-lg border border-gray-700">
                            <table class="min-w-full divide-y divide-gray-700">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-extrabold text-cyan-400 uppercase tracking-wider">Factor</th>
                                        <th class="px-4 py-3 text-left text-xs font-extrabold text-cyan-400 uppercase tracking-wider">Convenient (Ideal)</th>
                                        <th class="px-4 py-3 text-left text-xs font-extrabold text-cyan-400 uppercase tracking-wider">Selected Grid</th>
                                        <th class="px-4 py-3 text-left text-xs font-extrabold text-cyan-400 uppercase tracking-wider">Suitability (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody" class="bg-gray-800 divide-y divide-gray-700">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA SETUP (Constants unchanged) ---
        const PUFFER_CONVENIENT_FACTORS_CSV = `Fish,Life Stages,Duration (Weeks),Life time (Weeks),Convenient Temperature( degree C),Convenient Salinity(PSU),Convenient pH
Green spotted puffer,Juvenile,24,1-25,30,29,7.8
Green spotted puffer,Sub adult,62,25-87,29,32,8.2
Green spotted puffer,Adult,283,87-370,27,34,8.6`;

        const BANGUS_CONVENIENT_FACTORS_CSV = `Fish,Life Stages,Duration (Weeks),Life time (Weeks),Convenient Temperature( degree C),Convenient Salinity(PSU),Convenient pH
Milkfish (Bangus),Juvenile,18,1-19,28,32,8.0
Milkfish (Bangus),Sub adult,50,19-69,29,34,8.2
Milkfish (Bangus),Adult,300,69-369,30,36,8.4`;

        const GRID_INFO_CSV = `Grid,Sea Temperature (degree C),Salinity(PSU),pH,Direction
A1,24.038,33.491,7.948,North-west
A2,24.756,33.496,7.968,North-west
A3,25.532,33.518,7.978,West
A4,26.247,33.513,7.992,West
A5,27.012,33.502,8.01,West
A6,27.708,33.53,8.02,South-west
A7,28.484,33.508,8.038,South-west
B1,29.245,33.494,8.051,North-west
B2,30.0,29.0,7.8,North-west
B3,24.019,33.996,7.958,West
B4,24.769,33.994,7.979,West
B5,25.53,33.994,7.992,West
B6,26.25,34.006,8.01,South-west
B7,27.008,33.997,8.02,South-west
C1,27.728,34.0,8.036,North-west
C2,28.507,34.001,8.052,North-west
C3,29.259,34.004,8.064,West
C4,29.967,34.01,8.078,West
C5,24.017,34.488,7.979,West
C6,24.783,34.496,7.992,South-west
C7,25.489,34.513,8.007,South-west
D1,26.217,34.492,8.022,North
D2,26.983,34.493,8.034,North
D3,27.728,34.476,8.049,North-west
D4,28.47,34.504,8.068,West
D5,27.0,32.0,8.5,South-west
D6,29.984,34.505,8.09,South
D7,23.997,35.003,7.992,South
E1,24.735,34.999,8.008,North
E2,25.532,35.0,8.019,North
E3,26.194,35.005,8.032,North
E4,26.999,35.001,8.053,Origin
E5,27.748,35.02,8.063,South
E6,28.502,34.998,8.077,South
E7,29.23,35.034,8.09,South
F1,29.955,34.995,8.106,North
F2,23.991,35.502,8.004,North
F3,29.0,32.0,8.2,North-east
F4,25.503,35.493,8.033,East
F5,26.252,35.5,8.049,South-east
F6,26.0,18.0,7.0,South
F7,27.77,35.475,8.078,South
G1,28.519,35.507,8.097,North-east
G2,29.239,35.518,8.104,North-east
G3,29.993,35.506,8.121,East
G4,24.007,36.023,8.02,East
G5,27.0,34.0,8.6,East
G6,25.487,35.995,8.054,South-east
G7,26.247,35.988,8.066,South-east
H1,26.999,36.001,8.077,North-east
H2,27.795,35.996,8.092,North-east
H3,28.505,36.01,8.108,East
H4,29.0,15.0,7.5,East
H5,30.018,36.003,8.135,East
H6,24.01,36.485,8.039,South-east
H7,24.737,36.5,8.046,South-east
I1,25.494,36.509,8.066,North-east
I2,26.23,36.498,8.08,North-east
I3,27.014,36.508,8.093,East
I4,27.746,36.486,8.105,East
I5,28.488,36.489,8.119,East
I6,29.25,36.519,8.137,South-east
I7,30.025,36.503,8.149,South-east`;

        // --- GLOBAL VARIABLES & CONSTANTS ---
        let allConvenientFactors = {};
        let gridInfo = [];
        let canvas, ctx, gridPoints = {};
        let currentFish = ''; // Start unselected

        const GRID_ROWS = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'];
        const GRID_COLS = [1, 2, 3, 4, 5, 6, 7];
        const ORIGIN_GRID = 'E4';
        const MIGRATION_THRESHOLD = 85; 
        const MIGRATION_IMPROVEMENT_MIN = 5; 
        const VISUAL_GRID_SIZE = 20;

        const factors = [
            { name: 'Temperature', unit: '¬∞C', convenientKey: 'Convenient Temperature( degree C)', gridKey: 'Sea Temperature (degree C)', tolerance: 5.0 },
            { name: 'Salinity', unit: 'PSU', convenientKey: 'Convenient Salinity(PSU)', gridKey: 'Salinity(PSU)', tolerance: 10.0 },
            { name: 'pH', unit: '', convenientKey: 'Convenient pH', gridKey: 'pH', tolerance: 1.5 }
        ];

        // --- HELPER FUNCTIONS (unchanged) ---
        function parseCSV(csvString) { 
            const lines = csvString.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim());

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        const numericHeaders = factors.map(f => f.convenientKey).concat(factors.map(f => f.gridKey));
                        if (numericHeaders.includes(header)) {
                            row[header] = parseFloat(values[index]);
                        } else {
                            row[header] = values[index];
                        }
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function getFishInsight(fish) {
            if (fish === 'Puffer') {
                return `The **Green Spotted Puffer** thrives in environments transitioning from **brackish to fully marine** conditions as it matures. Its ideal factors (Temp: 27-30¬∞C, Salinity: 29-34 PSU, pH: 7.8-8.6) reflect its euryhaline adaptability. The analysis focuses on finding the closest match to these optimal marine-coastal conditions.`; 
            } else if (fish === 'Bangus') {
                return `The **Milkfish (Bangus)** is highly **euryhaline** and is often cultured in brackish water, but its adults spawn in marine zones. Its ideal factors (Temp: 28-30¬∞C, Salinity: 32-36 PSU, pH: 8.0-8.4) target the optimal growth stages across different salinity profiles. The migration check is crucial for identifying its ideal lifecycle path.`;
            }
            return "";
        }

        function calculateSuitability(gridData, convenientData) { 
            let totalSuitabilityScore = 0;
            const comparisonRows = [];

            factors.forEach(f => {
                const C = convenientData[f.convenientKey]; 
                const E = gridData[f.gridKey]; 

                if (typeof C !== 'number' || typeof E !== 'number') return;

                const deviation = Math.abs(C - E);
                let suitabilityFactor = Math.max(0, 1 - (deviation / f.tolerance));

                totalSuitabilityScore += suitabilityFactor;

                comparisonRows.push({
                    factor: f.name,
                    unit: f.unit,
                    convenient: C,
                    grid: E,
                    deviation: deviation,
                    suitability: suitabilityFactor
                });
            });

            const finalScore = (totalSuitabilityScore / factors.length) * 100;
            return { finalScore, comparisonRows };
        }
        
        // --- CANVAS & VISUALIZATION FUNCTIONS (unchanged in logic) ---
        function mapGridToCanvas() { 
            const container = document.getElementById('oceanMapContainer');
            canvas.width = container.clientWidth;
            canvas.height = 400; 

            const size = canvas.width;
            const height = canvas.height;
            const rowCount = GRID_ROWS.length; 
            const colCount = GRID_COLS.length; 

            const marginX = size * 0.08; 
            const marginY = height * 0.08; 

            const contentWidth = size - 2 * marginX; 
            const contentHeight = height - 2 * marginY; 

            const rowSpacing = contentHeight / (rowCount - 1); 
            const colSpacing = contentWidth / (colCount - 1); 

            gridPoints = {}; 

            gridInfo.forEach(data => {
                const gridId = data.Grid;
                const row = gridId.charAt(0);
                const col = parseInt(gridId.charAt(1));

                const rowIndex = GRID_ROWS.indexOf(row);
                const colIndex = GRID_COLS.indexOf(col);

                const x = marginX + (colIndex * colSpacing);
                const y = marginY + (rowIndex * rowSpacing);

                gridPoints[gridId] = { x, y, size: VISUAL_GRID_SIZE, data }; 
            });

            drawAxisLabels(marginX, marginY, colSpacing, rowSpacing); 
            redrawMap(); 
        }

        function drawAxisLabels(marginX, marginY, colSpacing, rowSpacing) {
            const colLabelsDiv = document.getElementById('colLabels');
            const rowLabelsDiv = document.getElementById('rowLabels');
            colLabelsDiv.innerHTML = '';
            rowLabelsDiv.innerHTML = '';

            // Draw Column Labels (1, 2, 3, ...) - Top of the map
            GRID_COLS.forEach((col, index) => {
                const x = marginX + (index * colSpacing);
                const label = document.createElement('div');
                label.className = 'map-axis-label absolute top-0 font-extrabold';
                label.textContent = col;
                label.style.left = `${x}px`;
                label.style.top = `${marginY - 25}px`;
                label.style.transform = 'translateX(-50%)';
                colLabelsDiv.appendChild(label);
            });

            // Draw Row Labels (A, B, C, ...) - Left of the map
            GRID_ROWS.forEach((row, index) => {
                const y = marginY + (index * rowSpacing);
                const label = document.createElement('div');
                label.className = 'map-axis-label absolute left-0 font-extrabold';
                label.textContent = row;
                label.style.left = `${marginX - 25}px`;
                label.style.top = `${y}px`;
                label.style.transform = 'translateY(-50%)';
                rowLabelsDiv.appendChild(label);
            });
        }

        function redrawMap(selectedGrid = null, targetGrid = null) {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#111827');
            gradient.addColorStop(1, '#064e3b');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = '#06b6d4'; 
            ctx.lineWidth = 2;
            ctx.strokeRect(0, 0, canvas.width, canvas.height);

            for (const [id, point] of Object.entries(gridPoints)) {
                let fillColor = '#ffffff'; 
                let strokeColor = '#22d3ee'; 
                let strokeWidth = 1.5;

                if (id === ORIGIN_GRID) {
                    fillColor = '#06b6d4'; 
                    strokeWidth = 3;
                    strokeColor = '#ffc300';
                }

                if (id === selectedGrid) {
                    fillColor = '#f97316'; 
                    strokeWidth = 4;
                    strokeColor = '#ffffff'; 
                }

                if (id === targetGrid) {
                    fillColor = '#10b981'; 
                    strokeWidth = 4;
                    strokeColor = '#ffffff'; 
                }

                ctx.beginPath(); 
                ctx.arc(point.x, point.y, point.size / 2, 0, Math.PI * 2);

                ctx.fillStyle = fillColor;
                ctx.fill(); 

                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = strokeWidth;
                ctx.stroke();

                ctx.fillStyle = '#1e3a8a';
                ctx.font = `bold 10px Inter`; 
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle'; 
                ctx.fillText(id, point.x, point.y + 1);
                ctx.closePath();
            }

            if (selectedGrid && targetGrid && selectedGrid !== targetGrid) {
                drawArrow(gridPoints[selectedGrid], gridPoints[targetGrid]);
            }
        }

        function drawArrow(start, end) { 
            ctx.strokeStyle = '#22d3ee'; 
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.shadowBlur = 8;
            ctx.shadowColor = '#06b6d4'; 

            const headlen = 10; 
            const angle = Math.atan2(end.y - start.y, end.x - start.x); 
            const distance = Math.sqrt(Math.pow(end.x - start.x, 2) + Math.pow(end.y - start.y, 2)); 

            const factor = 1 - (end.size / 2) / distance; 
            const arrowEnd = { x: start.x + (end.x - start.x) * factor, y: start.y + (end.y - start.y) * factor }; 

            const factorStart = (start.size / 2) / distance;
            const arrowStart = { x: start.x + (end.x - start.x) * factorStart, y: start.y + (end.y - start.y) * factorStart }; 

            ctx.beginPath();
            ctx.moveTo(arrowStart.x, arrowStart.y);
            ctx.lineTo(arrowEnd.x, arrowEnd.y);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(arrowEnd.x, arrowEnd.y);
            ctx.lineTo(arrowEnd.x - headlen * Math.cos(angle - Math.PI / 6), arrowEnd.y - headlen * Math.sin(angle - Math.PI / 6)); 
            ctx.moveTo(arrowEnd.x, arrowEnd.y);
            ctx.lineTo(arrowEnd.x - headlen * Math.cos(angle + Math.PI / 6), arrowEnd.y - headlen * Math.sin(angle + Math.PI / 6)); 
            ctx.stroke();

            ctx.shadowBlur = 0; 
        }

        function positionMapFish(fromGrid, toGrid, isMigrating = false) { 
            const mapFishIndicator = document.getElementById('mapFishIndicator');
            const startPoint = gridPoints[fromGrid];
            const endPoint = gridPoints[toGrid];
            if (!startPoint || !endPoint) return; 

            const targetXPercent = (endPoint.x / canvas.width) * 100; 
            const targetYPercent = (endPoint.y / canvas.height) * 100; 

            mapFishIndicator.style.display = 'block';
            mapFishIndicator.style.left = `${targetXPercent}%`;
            mapFishIndicator.style.top = `${targetYPercent}%`;

            let transformValue = 'translate(-50%, -50%)'; 

            if (isMigrating) {
                const angle = Math.atan2(endPoint.y - startPoint.y, endPoint.x - startPoint.x); 
                if (angle > Math.PI / 2 || angle < -Math.PI / 2) {
                    transformValue += ' scaleX(-1)'; 
                } else {
                    transformValue += ' scaleX(1)';
                }
            } else {
                transformValue += ' scaleX(1)';
            }
            mapFishIndicator.style.transform = transformValue; 
        }


        // --- APPLICATION CONTROL FUNCTIONS (Modified for unselected state) ---

        function initializeApp() {
            try {
                // 1. Parse All Data
                allConvenientFactors.Puffer = parseCSV(PUFFER_CONVENIENT_FACTORS_CSV).filter(row => row.Fish === 'Green spotted puffer');
                allConvenientFactors.Bangus = parseCSV(BANGUS_CONVENIENT_FACTORS_CSV).filter(row => row.Fish === 'Milkfish (Bangus)');
                gridInfo = parseCSV(GRID_INFO_CSV); 

                // 2. Setup Canvas
                canvas = document.getElementById('oceanMapCanvas'); 
                ctx = canvas.getContext('2d'); 

                const resizeCanvas = () => {
                    mapGridToCanvas(); 
                };

                resizeCanvas(); 
                window.addEventListener('resize', resizeCanvas); 

                // 3. Initial Setup: Call initializeFishData to populate grid options and set initial state
                initializeFishData();

                // Initial UI state setup
                document.getElementById('analysisTypeSelect').value = "Migration Simulation";
                toggleAnalysisMode();

            } catch (error) {
                console.error("Error during initialization:", error); 
            }
        }

        function toggleAnalysisMode() {
            checkInputs();
        }

        function initializeFishData() {
            currentFish = document.getElementById('fishSelect').value;
            const lifeStageSelect = document.getElementById('lifeStageSelect');
            const gridSelect = document.getElementById('gridSelect');
            const aiInsightCard = document.getElementById('aiInsightCard');

            // Always populate Grid Selector (only done once)
            if (gridSelect.options.length <= 1) { 
                gridInfo.forEach(data => {
                    const option = document.createElement('option');
                    option.value = data.Grid;
                    option.textContent = `${data.Grid} (${data.Direction.trim()})`;
                    gridSelect.appendChild(option);
                });
            }

            // Reset dependent selectors and fields
            lifeStageSelect.innerHTML = '<option value="" disabled selected>-- Choose Stage --</option>';
            gridSelect.value = ""; 

            if (!currentFish) {
                // No species selected. Set initial UI state.
                aiInsightCard.innerHTML = '<h2 class="text-lg font-bold text-cyan-400 mb-2">AI Insight</h2><p class="text-sm text-gray-400">Select a species above to view its habitat requirements and migration insights.</p>';
                document.getElementById('analyzeButton').disabled = true;
                document.getElementById('resultsDisplay').classList.add('hidden');
                document.getElementById('initialMessage').classList.remove('hidden');
                document.getElementById('mapFishIndicator').style.display = 'none';
                redrawMap(null, null);
                return;
            }

            const convenientFactors = allConvenientFactors[currentFish];
            const fishName = (currentFish === 'Puffer') ? 'Green Spotted Puffer' : 'Bangus (Milkfish)';

            // Update AI Insight with species data
            aiInsightCard.innerHTML = `<h2 class="text-lg font-bold text-cyan-400 mb-2">AI Insight: ${fishName}</h2><p class="text-sm text-gray-400">${getFishInsight(currentFish)}</p>`;

            // Populate Life Stage Selector
            const lifeStages = [...new Set(convenientFactors.map(f => f['Life Stages']))];
            lifeStages.forEach(stage => {
                const option = document.createElement('option');
                option.value = stage;
                option.textContent = stage;
                lifeStageSelect.appendChild(option);
            });

            // Re-run input check to update button state
            checkInputs(); 
        }

        function checkInputs() { 
            const selectedFish = document.getElementById('fishSelect').value;
            const lifeStage = document.getElementById('lifeStageSelect').value;
            const selectedGrid = document.getElementById('gridSelect').value;
            const button = document.getElementById('analyzeButton');
            
            // Button is enabled ONLY if all three selectors have a value
            button.disabled = !(selectedFish && lifeStage && selectedGrid); 

            if (selectedFish && lifeStage && selectedGrid) {
                document.getElementById('initialMessage').classList.add('hidden'); 
                document.getElementById('resultsDisplay').classList.add('hidden'); 
                redrawMap(selectedGrid, null);
                if (gridPoints[selectedGrid]) { 
                    positionMapFish(selectedGrid, selectedGrid, false);
                }
            } else {
                document.getElementById('initialMessage').classList.remove('hidden'); 
                document.getElementById('resultsDisplay').classList.add('hidden'); 
            }
        }

        function runAnalysis() { 
            const selectedLifeStage = document.getElementById('lifeStageSelect').value;
            const selectedGrid = document.getElementById('gridSelect').value;
            const convenientFactors = allConvenientFactors[currentFish];

            const convenientData = convenientFactors.find(f => f['Life Stages'] === selectedLifeStage); 
            const selectedGridData = gridInfo.find(g => g.Grid === selectedGrid); 

            if (!convenientData || !selectedGridData) return;

            const { finalScore, comparisonRows } = calculateSuitability(selectedGridData, convenientData);

            let migrationTarget = selectedGrid;
            let migrationMessage = `Suitability is **Excellent** (${finalScore.toFixed(1)}%). The ${currentFish === 'Puffer' ? 'Puffer' : 'Bangus'} remains in Grid ${selectedGrid}.`; 
            let messageClass = "border-green-400 bg-green-900/50 text-green-400"; // Dark Mode Green
            let isMigrating = false;

            if (finalScore < MIGRATION_THRESHOLD) { 
                let bestScore = -1;
                let bestGridId = selectedGrid;
                
                gridInfo.forEach(potentialGridData => {
                    const { finalScore: potentialScore } = calculateSuitability(potentialGridData, convenientData);
                    if (potentialScore > bestScore) {
                        bestScore = potentialScore;
                        bestGridId = potentialGridData.Grid;
                    }
                });

                if (bestGridId !== selectedGrid && bestScore > finalScore + MIGRATION_IMPROVEMENT_MIN) { 
                    migrationTarget = bestGridId; 
                    migrationMessage = `Suitability is **LOW** (${finalScore.toFixed(1)}%). The fish is predicted to **MIGRATE** from Grid ${selectedGrid} to Grid ${bestGridId}. (Target Suitability: ${bestScore.toFixed(1)}%).`; 
                    messageClass = "border-red-400 bg-red-900/50 text-red-400"; // Dark Mode Red
                    isMigrating = true; 
                } else {
                    migrationTarget = selectedGrid; 
                    migrationMessage = `Suitability is **LOW** (${finalScore.toFixed(1)}%), but the fish **STAYS** as no other tested location offers significantly better conditions (Max Potential: ${bestScore.toFixed(1)}%).`; 
                    messageClass = "border-yellow-400 bg-yellow-900/50 text-yellow-400"; // Dark Mode Yellow
                    isMigrating = false; 
                }
            }

            displayResults(finalScore, comparisonRows, selectedGridData.Direction, migrationTarget, migrationMessage, messageClass, selectedGrid, isMigrating);
        }

        function displayResults(score, rows, gridDirection, targetGrid, migrationMessage, messageClass, selectedGrid, isMigrating) { 
            const resultsDisplay = document.getElementById('resultsDisplay'); 
            const scoreText = document.getElementById('scoreText'); 
            const scoreBar = document.getElementById('scoreBar'); 
            const tableBody = document.getElementById('comparisonTableBody'); 
            const suitabilityVerdict = document.getElementById('suitabilityVerdict'); 
            const migrationStatusDiv = document.getElementById('migrationStatus'); 
            const migrationMsgP = document.getElementById('migrationMessage'); 
            const suitabilityFishIndicator = document.getElementById('suitabilityFishIndicator'); 

            resultsDisplay.classList.remove('hidden');

            // --- 1. Suitability Verdict and Score Bar ---
            let verdict, barColor;
            let textClass = 'text-gray-400';
            if (score >= 90) { 
                verdict = "Verdict: Excellent Match. Factors are near-perfect for this life stage. Optimal habitat.";
                barColor = 'bg-green-500';
                textClass = 'text-green-400';
            } else if (score >= 70) { 
                verdict = "Verdict: Good Match. Generally suitable, minor factor deviations. Stable habitat.";
                barColor = 'bg-lime-500';
                textClass = 'text-lime-400';
            } else if (score >= 50) { 
                verdict = "Verdict: Moderate Match. Notable factor deviations. Migration is probable if significantly better habitat is available.";
                barColor = 'bg-yellow-500';
                textClass = 'text-yellow-400';
            } else { 
                verdict = "Verdict: Poor Match. Highly unsuitable. Migration is strongly predicted.";
                barColor = 'bg-red-500';
                textClass = 'text-red-400';
            }

            scoreText.textContent = `${score.toFixed(1)}%`; 
            suitabilityVerdict.textContent = verdict; 
            suitabilityVerdict.className = `mt-3 text-sm italic font-medium ${textClass}`;
            scoreBar.style.width = `${score.toFixed(1)}%`; 
            scoreBar.className = `score-bar h-full rounded-lg ${barColor}`; 

            let fishPosition = score.toFixed(1); 
            let transformStyle = 'translate(-50%, -50%) scaleX(1)';
            if (score < 50) {
                transformStyle = 'translate(-50%, -50%) scaleX(-1)'; 
            }
            suitabilityFishIndicator.style.left = `${fishPosition}%`; 
            suitabilityFishIndicator.style.transform = transformStyle; 

            // --- 2. Migration Status & Comparison Table ---
            migrationStatusDiv.className = `p-5 rounded-xl border-4 ${messageClass}`; 
            migrationMsgP.innerHTML = migrationMessage; 
            tableBody.innerHTML = ''; 
            rows.forEach(row => {
                const tr = document.createElement('tr');
                let suitabilityClass = 'text-gray-300';
                if (row.suitability >= 0.85) suitabilityClass = 'text-green-400 font-bold';
                else if (row.suitability < 0.5) suitabilityClass = 'text-red-400 font-bold';
                
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-gray-300">${row.factor}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-cyan-400 font-medium">${row.convenient.toFixed(2)} ${row.unit}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-300">${row.grid.toFixed(2)} ${row.unit}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm ${suitabilityClass}">${(row.suitability * 100).toFixed(1)}%</td>
                `;
                tableBody.appendChild(tr); 
            });

            // --- 3. Update Map Visualization ---
            redrawMap(selectedGrid, targetGrid);
            if (gridPoints[selectedGrid] && gridPoints[targetGrid]) {
                positionMapFish(selectedGrid, targetGrid, isMigrating); 
            }
        }

        // Start the application when the window loads
        window.onload = initializeApp;
    </script>
</body>
</html>