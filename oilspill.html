<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquaris AI - Oil Spill Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0d0d0d;
        }
        .container { 
            max-width: 1000px; 
            margin: auto; 
            padding-top: 5rem; /* Space for the fixed header */
        }
        .card {
            background-color: #1a1a1a;
            border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        /* Custom scrollbar to match dark theme */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #06b6d4; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <header class="fixed top-0 left-0 w-full bg-gray-900 bg-opacity-90 backdrop-blur-sm z-50">
        <div class="container mx-auto px-4 py-3 flex justify-start items-center max-w-7xl">
            <a href="index.html" title="Back to Main Page"
               class="p-2 rounded-full hover:bg-gray-700 transition">
                <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-cyan-400 mb-10 mt-12">
            Oil Spill Detection & Dispersion Forecast
        </h1>

        <div class="grid lg:grid-cols-2 gap-8 mb-10">
            <div class="card p-6 rounded-xl space-y-4">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">1. Image Input</h2>
                <label for="imageUpload" class="block text-lg font-medium text-gray-300">
                    Upload Ocean Image (JPG/PNG)
                </label>
                <input type="file" id="imageUpload" accept="image/jpeg, image/png" 
                       class="w-full text-white bg-gray-700 border border-gray-600 rounded-lg p-3 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-600 file:text-white hover:file:bg-cyan-500 cursor-pointer">
                
                <div class="mt-4 border border-gray-700 rounded-lg overflow-hidden">
                    <img id="imagePreview" src="#" alt="Image Preview" 
                         class="max-w-full h-auto mx-auto block" style="display: none; max-height: 300px; object-fit: contain;">
                    <p id="previewPlaceholder" class="text-center text-gray-500 py-10" style="display: block;">Image preview will appear here.</p>
                </div>
            </div>

            <div class="card p-6 rounded-xl space-y-4">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-700 pb-2">2. Environmental Factors</h2>
                
                <p class="text-gray-400">
                    Enter the three key environmental factors for dispersion forecasting.
                </p>

                <div>
                    <label for="windSpeed" class="block text-sm font-medium text-gray-400">Wind Speed (m/s)</label>
                    <input type="number" id="windSpeed" value="5.0" step="0.1" min="0" 
                           class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                
                <div>
                    <label for="wavePeriod" class="block text-sm font-medium text-gray-400">Wave Speed (m/s)</label>
                    <input type="number" id="wavePeriod" value="6.0" step="0.1" min="0" 
                           class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                
                <div>
                    <label for="latitude" class="block text-sm font-medium text-gray-400">Latitude (deg)</label>
                    <input type="number" id="latitude" value="10.0" step="1" min="0" max="90" 
                           class="w-full p-2 mt-1 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-cyan-500 focus:border-cyan-500">
                </div>
                
            </div>
        </div>
        
        <button id="predictBtn" 
                class="w-full bg-cyan-600 text-white text-xl font-bold py-4 rounded-xl hover:bg-cyan-500 transition shadow-lg shadow-cyan-900/50 mb-8 disabled:bg-gray-600 disabled:cursor-not-allowed">
            Run Oil Spill Analysis & Forecast üîç
        </button>
        <p id="statusMessage" class="text-center font-medium mb-4"></p>

        <div id="results" class="card p-6 rounded-xl space-y-4" style="display: none;">
            <h2 class="text-2xl font-semibold border-b border-gray-700 pb-2 text-cyan-400">3. Analysis Report</h2>
            
            <div id="detectionStatusContainer" class="p-4 rounded-lg">
                <p id="detectionStatus" class="text-xl font-bold"></p>
                <p id="envSummary" class="text-gray-400 mt-1"></p>
            </div>
            
            <div id="forecastContainer" class="pt-4 border-t border-gray-700" style="display: none;">
                <h3 class="text-xl font-semibold mb-3">Dispersion Forecast</h3>
                <p class="text-sm text-gray-400 mb-4">
                    Projected growth of the oil slick over the next week based on current factors.
                </p>
                
                <p class="mb-4">Area Growth: <span id="growthSummary" class="font-bold text-cyan-400"></span></p>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-300 rounded-lg overflow-hidden">
                        <thead class="text-xs text-white uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="py-3 px-6">Day</th>
                                <th scope="col" class="py-3 px-6">Total Area ($km^2$)</th>
                            </tr>
                        </thead>
                        <tbody id="forecastTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer id="contact" class="py-8 bg-gray-900 text-center text-gray-500 border-t border-gray-700 mt-10">
        <p>&copy; 2025 Aquaris AI. All rights reserved.</p>
    </footer>

    <script>
        const API_ENDPOINT = 'https://aquarisai-production.up.railway.app/api/analyze_spill';

        // Get DOM Elements
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const predictBtn = document.getElementById('predictBtn');
        const statusMessage = document.getElementById('statusMessage');
        const resultsDiv = document.getElementById('results');
        const detectionStatusContainer = document.getElementById('detectionStatusContainer');
        const detectionStatus = document.getElementById('detectionStatus');
        const envSummary = document.getElementById('envSummary');
        const forecastContainer = document.getElementById('forecastContainer');
        const forecastTableBody = document.getElementById('forecastTableBody');
        const growthSummary = document.getElementById('growthSummary');


        // 1. Image Preview and Base64 Conversion
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                imagePreview.src = URL.createObjectURL(file);
                imagePreview.style.display = 'block';
                previewPlaceholder.style.display = 'none';
            } else {
                imagePreview.style.display = 'none';
                previewPlaceholder.style.display = 'block';
            }
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result); 
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // 2. Prediction Handler
        predictBtn.addEventListener('click', async () => {
            const imageFile = imageUpload.files[0];
            
            statusMessage.textContent = '';
            resultsDiv.style.display = 'none';
            predictBtn.disabled = true;

            if (!imageFile) {
                statusMessage.textContent = 'Please upload an image first.';
                statusMessage.className = 'text-red-500';
                predictBtn.disabled = false;
                return;
            }

            statusMessage.textContent = 'Processing... Running CNN and Regression Models.';
            statusMessage.className = 'text-cyan-400';

            try {
                const base64Data = await fileToBase64(imageFile); 
                
                const requestData = {
                    image_data: base64Data,
                    // Only send the three required fields
                    wind_speed: parseFloat(document.getElementById('windSpeed').value),
                    // Value is from 'wavePeriod' ID which sends the Wave Speed value
                    wave_period: parseFloat(document.getElementById('wavePeriod').value), 
                    latitude: parseFloat(document.getElementById('latitude').value),
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    displayResults(result);
                    statusMessage.textContent = 'Analysis complete!';
                    statusMessage.className = 'text-green-500';
                } else {
                    statusMessage.textContent = `Error: ${result.error || 'API call failed'}`;
                    statusMessage.className = 'text-red-500';
                }

            } catch (error) {
                console.error('Fetch error:', error);
                statusMessage.textContent = 'A network error occurred.';
                statusMessage.className = 'text-red-500';
            } finally {
                predictBtn.disabled = false;
            }
        });

        // 3. Display Results
        function displayResults(result) {
            resultsDiv.style.display = 'block';
            envSummary.textContent = result.environmental_summary;
            forecastTableBody.innerHTML = ''; 
            forecastContainer.style.display = 'none';

            if (result.oil_detected) {
                detectionStatus.innerHTML = `üö® OIL SPILL DETECTED! (Confidence: ${result.confidence})`;
                detectionStatusContainer.className = 'p-4 rounded-lg bg-red-900/50 border border-red-700';

                if (result.dispersion_forecast && result.dispersion_forecast.length > 0) {
                    forecastContainer.style.display = 'block';
                    
                    let startArea = result.dispersion_forecast[0].area_km2_total;
                    let endArea = result.dispersion_forecast[result.dispersion_forecast.length - 1].area_km2_total;
                    let timeSpan = result.dispersion_forecast[result.dispersion_forecast.length - 1].day;
                    let rate = (endArea - startArea).toFixed(2);
                    
                    growthSummary.textContent = `${startArea} km¬≤ (Day 1) to ${endArea} km¬≤ (Day ${timeSpan}) | Total Growth: +${rate} km¬≤`;

                    result.dispersion_forecast.forEach(item => {
                        const row = forecastTableBody.insertRow();
                        row.className = 'border-b border-gray-700 hover:bg-gray-800';
                        
                        const dayCell = row.insertCell(0);
                        const areaCell = row.insertCell(1);
                        dayCell.className = 'py-3 px-6 font-medium text-white';
                        areaCell.className = 'py-3 px-6 text-cyan-400';
                        
                        dayCell.textContent = `Day ${item.day}`;
                        areaCell.textContent = item.area_km2_total;
                    });
                } else {
                    growthSummary.textContent = 'Forecast data unavailable.';
                    forecastContainer.style.display = 'block';
                }

            } else {
                detectionStatus.innerHTML = `‚úÖ NO OIL SPILL DETECTED (Confidence: ${(1.0 - result.confidence).toFixed(3)})`;
                detectionStatusContainer.className = 'p-4 rounded-lg bg-green-900/50 border border-green-700';
                forecastContainer.style.display = 'none';
            }
        }
    </script>
</body>
</html>